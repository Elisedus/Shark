---
title: "Shark simulation tutorial"
author: "Jeffrey Durieux and Elise Dusseldorp"
date: "01/10/2018"
output: 
  pdf_document:
    toc: true 
    toc_depth: 2
    number_sections: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introduction

In this document, we describe the set-up of a simulation study and the performance of it on a cluster computer (shark). The document is structured as follows:

* Chapter 2: Specification of a simulation study;
* Chapter 3: Preparation of a simulation study;
* Chapter 4: Performance of a simulation study on a cluster computer;
* Chapter 5: Collecting the results from the cluster computer in one large matrix and evaluation of the results by anova;


# Specification of a simulation study

In a full factorial simulation study, we consider the following 3 steps:

* Step 1: Gauge and design

* Step 2: Statistical Analysis

* Step 3: Evaluation Criteria

## Step 1: Gauge and design

Start with the formulation of:

*	the true scenario(s)/model(s) from which you will generate your artificial data, and specify from which distributions you generate the variables  that are included in the model. 

*	specify the design factors (i.e. the factors you are going to vary systematically). In our example, we refer to these factors as:

    +	Samp (sample size, having 3 levels: N = 100, 500, 1000);
    +	Es (effectsize, having 2 levels: d = 0.5 and 1.0), and
    +	J (number of predictors, having 2 levels: j = 5 and 20) 

*	number of replications within each cell: k. In our small example, k =10

For our example, our design contains in total 3 (Samp) by 2 (ES) by 2 (J) = 12 cells. For each cell we will generate *k* = 10 data sets.


## Step 2: Statistical Analysis

Specify the type of analysis you want to perform for each dataset (of each cell of the design). Often you want to compare two types of analysis methods (a new method compared to an “old” method). In our example, we refer to these methods as Method_new and Method_old.


## Step 3: Evaluation Criteria

Specify the evaluation criteria which you want to use to compare the two methods. In our example, we refer to the evaluation criterion as Criterion1.


# Preparation of a simulation study

Write the following functions in \texttt{R}: 

*	a function that generates one data set for each true scenario. The input arguments of this function are the type of true model and the levels of the factors of the simulation design. In our example, we refer to this function as *MySimDataFunction.r*. The output of this function is a simulated data set (SimData);

*	One or two functions that analyse the data according to one method. In our example, we refer to this function as *Method_new.r*. The input argument of this function is a dataset (and possibly more input arguments). The output of this function contains the relevant results. In our example, we refer to this as MyAnalysisResult;

*	a function that applies the evaluation criterion. In our example, we refer to this function as *MyEvaluationResult.r*. The input of this function is MyAnalysisResult.


# Performance of a simulation study on a cluster computer

## The main simulation script: MySimulationScript.R
Note the piece of code on the second line in the script. The R function commandArgs() extracts command line arguments. This function enables us to run our whole simulation script with some provided parameters to the script. 

Note: in order to use R on shark, you first need to 'load' it. This can simply be done on the command line, type: module load R/3.3.3 (or take another version)


```{#numCode .R .numberLines}
   # args is a stringvector
   args <- commandArgs(TRUE)
   args <- as.numeric(args)
   
   RowOfDesign <- args[1]
   Replication <- args[2]
   
   set.seed(Replication * RowOfDesign)
   
   ### Libraries and source code
   library(ica)
   library(mclust)
   source("/YOUR_PATH_TO_DIRECTORY_WITH_SCRIPTS/MyUsefullFunctions.R")
   
   
   ### Simulation design 
   Components <- c(2, 5, 20)
   Clusters <- c(2, 4)
   Error <- c(0.05, 0.2, 0.5)
   
   
   # expand.grid is usefull function to obtain a data.frame that contains all 
   # possible combinations of the specified factor levels
   # In this example, Desing will have 12 rows and 3 columns
   
   Design <- expand.grid(Components = Components, Clusters = Clusters, Error = Error)
   
   ######### simulation ###########
   
   # Step 1: Generate data
   SimData<-do.call( MySimDataFunction, as.list( Design[ RowOfDesign, ] ) )
   
   # Step 2: Analyze data
   
   tmp <- proc.time() # start timer
   
   Analysis <- MyFunction(data = SimData$X, nQ =Design$Components[RowOfDesign] ,
               nC = Design$Clusters[RowOfDesign])
   
   time <- proc.time() - tmp  # calculate duration of analysis
   
   # Step 3: Evaluate simulation
   ARI <- adjustedRandIndex(SimData$P, Analysis$P)
   
   # save stuff in your directory
   # Note that for the Shark cluster, it is advised to store data on /exports/fsw/YOURDIRECTORY
   setwd("/exports/fsw/durieuxj/")
   
   # Write output, also possible to first save everything in a list object
   save(Simdata, file =paste("Simdata",RowOfDesign, Replication ,".Rdata" , sep ="")
   save(Analysis, file =paste("Analysis",RowOfDesign, Replication ,".Rdata" , sep ="")
   save(ARI, file =paste("Evaluation",RowOfDesign, Replication ,".Rdata" , sep ="")
   save(time, file =paste("Time",RowOfDesign, Replication ,".Rdata" , sep ="")
```

## The bash script used to run Jobs

Below you can find a bash script (let's call it RunMySim.sh) that is used on Shark to run a \texttt{R}-script
The bash script 'starts' the \texttt{R}-script 'MySimulationScript.R' with the command R CMD BATCH and includes some provided arguments: \$i and \$j. The \$ sign indicates that it is a replacement character, with a for loop we will change those values on the fly (see next part). The values provided to these replacement characeters will be collected with the commandArgs() function in our \texttt{R}-script. Also note that you can receive an email notification when your job starts and when it is finished. Just change my emailadress please :)

```{#numCode .sh .numberLines}

#!/bin/bash
#$ -S /bin/bash
#$ -q all.q
#$ -N sim_1
#$ -cwd
#$ -j Y
#$ -V
#$ -m be
#$ -M YOUREMAIL@fsw.leidenuniv.nl 

R CMD BATCH "--args $i $j" MySimulationScript.R

```


## Start your embarrassingly parallel jobs

We have a \texttt{R}-script with simulation code. We also have a bash script RunMySim.sh. But how do we actually start our simulation? We simply use the qsub command in a (double) for loop.

Our simulation design consists out of three factors: Clusters, Components and Error. The factors have 3, 2 and 3 levels respectively. So we have a 3x2x3 factorial design. Our design matrix (a matrix where all combinations of the factor levels are represented) has, therefore, 3x2x3=18 rows.

Let say we will use 10 replications of this design. We can then use a double for loop to qsub our bash script to the Shark job scheduler. The iterators of the double for loop is also our parameters that we pass to our bash script (and the bash script subsequently pass those parameters to our R-script). 

You can submit this double for loop on the command line in Shark. This double for loop will start 10x18=180 jobs that will run in parallel. Each job has no dependency on each other, meaning that you can run each row of the design completely seperate. This is known as embarrasingly parallel computing and it saves you a lot of comutation time!

```{#numCode .sh .numberlines}

for replication in {1..10}
do
  for rownumber in {1..18}
  do
    qsub -l h_vmem=4G -v i=$rownumber,j=$replication RunMySim.sh
  done
done
```

# Collecting the results and evaluate with ANOVA

# Installing R packages on Shark

R script 'InstallPackages.R':
```{r, eval=F}
install.packages(c("ica","Matrix"), Sys.getenv("R_LIBS_USER"), repos = "http://cran.case.edu")
```

Bash script: InstallPackages.sh
```{#numCode .sh .numberlines}
#!/bin/bash
#$ -S /bin/bash
#$ -q all.q
#$ -N installpackages
#$ -cwd
#$ -j Y
#$ -V
#$ -m be
#$ -M j.durieux@fsw.leidenuniv.nl

R CMD BATCH InstallPackages.R
```

How to run it in Shark:
On the commandline type: qsub InstallPackages.sh

Don't forget to load R first (module load R/3.3.3)



